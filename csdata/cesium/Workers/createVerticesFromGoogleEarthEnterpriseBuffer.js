define(["./AxisAlignedBoundingBox-718a9087","./Transforms-1142ce48","./Cartesian2-08065eec","./when-ad3237a0","./TerrainEncoding-cd3482b3","./Math-5ca9b250","./OrientedBoundingBox-2cc6ca57","./RuntimeError-767bd866","./WebMercatorProjection-2bca7e98","./createTaskProcessorWorker","./Check-be2d5acb","./combine-1510933d","./AttributeCompression-9fbb8447","./ComponentDatatype-a867ddaa","./WebGLConstants-1c8239cc","./EllipsoidTangentPlane-f8b1fc8b","./IntersectionTests-75083888","./Plane-bb88dd7e"],function(ve,Me,xe,Ne,be,Se,we,Be,Pe,e,t,i,n,a,r,o,s,u){"use strict";var Ae=Uint16Array.BYTES_PER_ELEMENT,ye=Int32Array.BYTES_PER_ELEMENT,Re=Uint32Array.BYTES_PER_ELEMENT,_e=Float32Array.BYTES_PER_ELEMENT,We=Float64Array.BYTES_PER_ELEMENT;function Fe(e,t,i){i=Ne.defaultValue(i,Se.CesiumMath);for(var n=e.length,a=0;a<n;++a)if(i.equalsEpsilon(e[a],t,Se.CesiumMath.EPSILON12))return a;return-1}var Oe=new xe.Cartographic,Ye=new xe.Cartesian3,ke=new xe.Cartesian3,Ue=new xe.Cartesian3,Ve=new Me.Matrix4;function He(e,t,i,n,a,r,o,s,u,h,c){for(var d=s.length,g=0;g<d;++g){var l=s[g],m=l.cartographic,p=l.index,I=e.length,E=m.longitude,T=m.latitude,T=Se.CesiumMath.clamp(T,-Se.CesiumMath.PI_OVER_TWO,Se.CesiumMath.PI_OVER_TWO),m=m.height-o.skirtHeight;o.hMin=Math.min(o.hMin,m),xe.Cartographic.fromRadians(E,T,m,Oe),h&&(Oe.longitude+=u),h?g===d-1?Oe.latitude+=c:0===g&&(Oe.latitude-=c):Oe.latitude+=u;T=o.ellipsoid.cartographicToCartesian(Oe);e.push(T),t.push(m),i.push(xe.Cartesian2.clone(i[p])),0<n.length&&n.push(n[p]),0<a.length&&a.push(a[p]),Me.Matrix4.multiplyByPoint(o.toENU,T,Ye);m=o.minimum,T=o.maximum;xe.Cartesian3.minimumByComponent(Ye,m,m),xe.Cartesian3.maximumByComponent(Ye,T,T);T=o.lastBorderPoint;Ne.defined(T)&&(T=T.index,r.push(T,I-1,I,I,p,T)),o.lastBorderPoint=l}}return e(function(e,t){e.ellipsoid=xe.Ellipsoid.clone(e.ellipsoid),e.rectangle=xe.Rectangle.clone(e.rectangle);var i=function(e,t,i,n,a,r,o,s,u,h,c){var d,g,l,m,p;le=Ne.defined(n)?(d=n.west,g=n.south,l=n.east,m=n.north,p=n.width,n.height):(d=Se.CesiumMath.toRadians(a.west),g=Se.CesiumMath.toRadians(a.south),l=Se.CesiumMath.toRadians(a.east),m=Se.CesiumMath.toRadians(a.north),p=Se.CesiumMath.toRadians(n.width),Se.CesiumMath.toRadians(n.height));var I,E,T=[g,m],C=[d,l],f=Me.Transforms.eastNorthUpToFixedFrame(t,i),v=Me.Matrix4.inverseTransformation(f,Ve);u&&(I=Pe.WebMercatorProjection.geodeticLatitudeToMercatorAngle(g),E=1/(Pe.WebMercatorProjection.geodeticLatitudeToMercatorAngle(m)-I));var M=1!==r,x=new DataView(e),N=Number.POSITIVE_INFINITY,b=Number.NEGATIVE_INFINITY,S=ke;S.x=Number.POSITIVE_INFINITY,S.y=Number.POSITIVE_INFINITY,S.z=Number.POSITIVE_INFINITY;var w=Ue;w.x=Number.NEGATIVE_INFINITY,w.y=Number.NEGATIVE_INFINITY,w.z=Number.NEGATIVE_INFINITY;var B,P,A=0,y=0,R=0;for(P=0;P<4;++P){var _=A;B=x.getUint32(_,!0),_+=Re;var W=Se.CesiumMath.toRadians(180*x.getFloat64(_,!0));_+=We,-1===Fe(C,W)&&C.push(W);W=Se.CesiumMath.toRadians(180*x.getFloat64(_,!0));_+=We,-1===Fe(T,W)&&T.push(W),_+=2*We;W=x.getInt32(_,!0);_+=ye,y+=W,W=x.getInt32(_,!0),R+=3*W,A+=B+Re}var F=[],O=[],Y=new Array(y),k=new Array(y),U=new Array(y),V=u?new Array(y):[],H=M?new Array(y):[],L=new Array(R),D=[],G=[],j=[],z=[],q=0,J=0;for(P=A=0;P<4;++P){B=x.getUint32(A,!0);var K=A+=Re,Q=Se.CesiumMath.toRadians(180*x.getFloat64(A,!0));A+=We;var X=Se.CesiumMath.toRadians(180*x.getFloat64(A,!0));A+=We;var Z=Se.CesiumMath.toRadians(180*x.getFloat64(A,!0)),$=.5*Z;A+=We;var ee=Se.CesiumMath.toRadians(180*x.getFloat64(A,!0)),te=.5*ee;A+=We;var ie=x.getInt32(A,!0);A+=ye;var ne=x.getInt32(A,!0);A+=ye,A+=ye;for(var ae=new Array(ie),re=0;re<ie;++re){var oe=Q+x.getUint8(A++)*Z;Oe.longitude=oe;var se=X+x.getUint8(A++)*ee;Oe.latitude=se;var ue=x.getFloat32(A,!0);if(A+=_e,0!==ue&&ue<c&&(ue*=-Math.pow(2,h)),ue*=6371010,Oe.height=ue,-1!==Fe(C,oe)||-1!==Fe(T,se)){var he=Fe(F,Oe,xe.Cartographic);if(-1!==he){ae[re]=O[he];continue}F.push(xe.Cartographic.clone(Oe)),O.push(q)}ae[re]=q,Math.abs(oe-d)<$?D.push({index:q,cartographic:xe.Cartographic.clone(Oe)}):Math.abs(oe-l)<$?j.push({index:q,cartographic:xe.Cartographic.clone(Oe)}):Math.abs(se-g)<te?G.push({index:q,cartographic:xe.Cartographic.clone(Oe)}):Math.abs(se-m)<te&&z.push({index:q,cartographic:xe.Cartographic.clone(Oe)}),N=Math.min(ue,N),b=Math.max(ue,b),U[q]=ue;he=i.cartographicToCartesian(Oe);Y[q]=he,u&&(V[q]=(Pe.WebMercatorProjection.geodeticLatitudeToMercatorAngle(se)-I)*E),M&&(ue=i.geodeticSurfaceNormal(he),H[q]=ue),Me.Matrix4.multiplyByPoint(v,he,Ye),xe.Cartesian3.minimumByComponent(Ye,S,S),xe.Cartesian3.maximumByComponent(Ye,w,w);oe=(oe-d)/(l-d);oe=Se.CesiumMath.clamp(oe,0,1);se=(se-g)/(m-g);se=Se.CesiumMath.clamp(se,0,1),k[q]=new xe.Cartesian2(oe,se),++q}for(var ce=3*ne,de=0;de<ce;++de,++J)L[J]=ae[x.getUint16(A,!0)],A+=Ae;if(B!==A-K)throw new Be.RuntimeError("Invalid terrain tile.")}Y.length=q,k.length=q,U.length=q,u&&(V.length=q);M&&(H.length=q);var ge=q,a=J,e={hMin:N,lastBorderPoint:void 0,skirtHeight:s,toENU:v,ellipsoid:i,minimum:S,maximum:w};D.sort(function(e,t){return t.cartographic.latitude-e.cartographic.latitude}),G.sort(function(e,t){return e.cartographic.longitude-t.cartographic.longitude}),j.sort(function(e,t){return e.cartographic.latitude-t.cartographic.latitude}),z.sort(function(e,t){return t.cartographic.longitude-e.cartographic.longitude});s=1e-5;{var le;He(Y,U,k,V,H,L,e,D,-s*p,!0,-s*le),He(Y,U,k,V,H,L,e,G,-s*le,!1),He(Y,U,k,V,H,L,e,j,s*p,!0,s*le),He(Y,U,k,V,H,L,e,z,s*le,!1),0<D.length&&0<z.length&&(pe=D[0].index,Ie=z[z.length-1].index,le=Y.length-1,L.push(Ie,le,ge,ge,pe,Ie))}y=Y.length;var me,pe=Me.BoundingSphere.fromPoints(Y);Ne.defined(n)&&(me=we.OrientedBoundingBox.fromRectangle(n,N,b,i));for(var Ie=new be.EllipsoidalOccluder(i).computeHorizonCullingPointPossiblyUnderEllipsoid(t,Y,N),n=new ve.AxisAlignedBoundingBox(S,w,t),Ee=new be.TerrainEncoding(t,n,e.hMin,b,f,!1,u,M,r,o),Te=new Float32Array(y*Ee.stride),Ce=0,fe=0;fe<y;++fe)Ce=Ee.encode(Te,Ce,Y[fe],k[fe],U[fe],void 0,V[fe],H[fe]);e=D.map(function(e){return e.index}).reverse(),f=G.map(function(e){return e.index}).reverse(),r=j.map(function(e){return e.index}).reverse(),o=z.map(function(e){return e.index}).reverse();return f.unshift(r[r.length-1]),f.push(e[0]),o.unshift(e[e.length-1]),o.push(r[0]),{vertices:Te,indices:new Uint16Array(L),maximumHeight:b,minimumHeight:N,encoding:Ee,boundingSphere3D:pe,orientedBoundingBox:me,occludeePointInScaledSpace:Ie,vertexCountWithoutSkirts:ge,indexCountWithoutSkirts:a,westIndicesSouthToNorth:e,southIndicesEastToWest:f,eastIndicesNorthToSouth:r,northIndicesWestToEast:o}}(e.buffer,e.relativeToCenter,e.ellipsoid,e.rectangle,e.nativeRectangle,e.exaggeration,e.exaggerationRelativeHeight,e.skirtHeight,e.includeWebMercatorT,e.negativeAltitudeExponentBias,e.negativeElevationThreshold),n=i.vertices;return t.push(n.buffer),e=i.indices,t.push(e.buffer),{vertices:n.buffer,indices:e.buffer,numberOfAttributes:i.encoding.stride,minimumHeight:i.minimumHeight,maximumHeight:i.maximumHeight,boundingSphere3D:i.boundingSphere3D,orientedBoundingBox:i.orientedBoundingBox,occludeePointInScaledSpace:i.occludeePointInScaledSpace,encoding:i.encoding,vertexCountWithoutSkirts:i.vertexCountWithoutSkirts,indexCountWithoutSkirts:i.indexCountWithoutSkirts,westIndicesSouthToNorth:i.westIndicesSouthToNorth,southIndicesEastToWest:i.southIndicesEastToWest,eastIndicesNorthToSouth:i.eastIndicesNorthToSouth,northIndicesWestToEast:i.northIndicesWestToEast}})});
